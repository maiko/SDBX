{{define "title"}}SDBX - Configuration{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Configuration Editor</h1>
    <p>Edit your SDBX configuration (.sdbx.yaml)</p>
</div>

<!-- Toast notifications -->
<div id="toast-container" class="toast-container"></div>

<div class="config-editor-container">
    <div class="editor-toolbar">
        <button id="validate-btn" class="btn-sm btn-secondary-sm" onclick="validateConfig()">
            ‚úì Validate
        </button>
        <button id="save-btn" class="btn-sm btn-primary-sm" onclick="saveConfig()">
            üíæ Save
        </button>
        <button id="reload-btn" class="btn-sm btn-secondary-sm" onclick="reloadConfig()">
            ‚Üª Reload
        </button>
        <div class="editor-info">
            <span id="line-count">Lines: 0</span>
            <span id="char-count">Chars: 0</span>
        </div>
    </div>

    <div class="editor-wrapper">
        <div class="line-numbers" id="line-numbers"></div>
        <textarea id="config-editor" class="config-textarea" spellcheck="false">{{.ConfigContent}}</textarea>
    </div>

    <div id="validation-result" class="validation-result" style="display: none;"></div>
</div>

<div class="config-help">
    <h3>‚ö†Ô∏è Important Notes</h3>
    <ul>
        <li>Always <strong>validate</strong> before saving to catch syntax errors</li>
        <li>A backup is created automatically before saving (.sdbx.yaml.backup)</li>
        <li>After saving, run <code>sdbx down && sdbx up</code> to apply changes</li>
        <li>Invalid configurations can break your setup - be careful!</li>
    </ul>
</div>

<style>
    .toast-container {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .toast {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        min-width: 300px;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        border-left: 4px solid var(--color-success);
    }

    .toast.error {
        border-left: 4px solid var(--color-error);
    }

    .toast-icon {
        font-size: 1.25rem;
    }

    .toast-message {
        flex: 1;
        font-size: 0.875rem;
        word-break: break-word;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .config-editor-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .editor-toolbar {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .editor-info {
        margin-left: auto;
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: #64748b;
    }

    .editor-wrapper {
        display: flex;
        background: #1e293b;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    .line-numbers {
        background: #0f172a;
        color: #64748b;
        padding: 1rem 0.75rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        user-select: none;
        text-align: right;
        min-width: 3rem;
    }

    .config-textarea {
        flex: 1;
        background: #1e293b;
        color: #e2e8f0;
        border: none;
        padding: 1rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        resize: vertical;
        min-height: 500px;
        outline: none;
        white-space: pre;
        overflow-wrap: normal;
        overflow-x: auto;
    }

    .config-textarea::selection {
        background: rgba(124, 58, 237, 0.3);
    }

    .validation-result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
    }

    .validation-result.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
    }

    .validation-result.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .validation-result h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
    }

    .validation-result ul {
        margin: 0;
        padding-left: 1.5rem;
    }

    .config-help {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        border-radius: 8px;
        padding: 1.5rem;
    }

    .config-help h3 {
        margin: 0 0 1rem 0;
        color: #92400e;
    }

    .config-help ul {
        margin: 0;
        padding-left: 1.5rem;
        color: #78350f;
    }

    .config-help li {
        margin-bottom: 0.5rem;
    }

    .config-help code {
        background: #fcd34d;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }
</style>

<script>
    const editor = document.getElementById('config-editor');
    const lineNumbers = document.getElementById('line-numbers');
    const lineCount = document.getElementById('line-count');
    const charCount = document.getElementById('char-count');
    const validationResult = document.getElementById('validation-result');

    // Initialize
    updateLineNumbers();
    updateStats();

    // Update line numbers
    function updateLineNumbers() {
        const lines = editor.value.split('\n').length;
        let numbers = '';
        for (let i = 1; i <= lines; i++) {
            numbers += i + '\n';
        }
        lineNumbers.textContent = numbers;
    }

    // Update stats
    function updateStats() {
        const lines = editor.value.split('\n').length;
        const chars = editor.value.length;
        lineCount.textContent = `Lines: ${lines}`;
        charCount.textContent = `Chars: ${chars}`;
    }

    // Sync scroll
    editor.addEventListener('scroll', () => {
        lineNumbers.scrollTop = editor.scrollTop;
    });

    // Update on input
    editor.addEventListener('input', () => {
        updateLineNumbers();
        updateStats();
        validationResult.style.display = 'none';
    });

    // Tab handling
    editor.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + 2;
            updateLineNumbers();
            updateStats();
        }
    });

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = type === 'success' ? '‚úì' : '‚úó';

        // Use textContent to prevent XSS from API responses
        const iconSpan = document.createElement('span');
        iconSpan.className = 'toast-icon';
        iconSpan.textContent = icon;

        const msgSpan = document.createElement('span');
        msgSpan.className = 'toast-message';
        msgSpan.textContent = message;

        toast.appendChild(iconSpan);
        toast.appendChild(msgSpan);

        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    function validateConfig() {
        const btn = document.getElementById('validate-btn');
        btn.disabled = true;
        btn.textContent = 'Validating...';

        const formData = new FormData();
        formData.append('content', editor.value);

        fetch('/api/config/validate', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Clear previous content safely
            validationResult.textContent = '';

            if (data.success) {
                validationResult.className = 'validation-result success';
                const h4 = document.createElement('h4');
                h4.textContent = '‚úì Validation Successful';
                const p = document.createElement('p');
                p.textContent = 'Configuration is valid and ready to save.';
                validationResult.appendChild(h4);
                validationResult.appendChild(p);
                showToast('Configuration is valid', 'success');
            } else {
                validationResult.className = 'validation-result error';
                const h4 = document.createElement('h4');
                h4.textContent = '‚úó Validation Failed';
                validationResult.appendChild(h4);

                if (data.errors && data.errors.length > 0) {
                    const ul = document.createElement('ul');
                    data.errors.forEach(err => {
                        const li = document.createElement('li');
                        li.textContent = err; // Safe: uses textContent
                        ul.appendChild(li);
                    });
                    validationResult.appendChild(ul);
                } else {
                    const p = document.createElement('p');
                    p.textContent = data.message; // Safe: uses textContent
                    validationResult.appendChild(p);
                }
                showToast(data.message, 'error');
            }
            validationResult.style.display = 'block';
            btn.disabled = false;
            btn.textContent = '‚úì Validate';
        })
        .catch(error => {
            showToast('Validation failed: ' + error, 'error');
            btn.disabled = false;
            btn.textContent = '‚úì Validate';
        });
    }

    function saveConfig() {
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const formData = new FormData();
        formData.append('content', editor.value);

        fetch('/api/config/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Clear previous content safely
            validationResult.textContent = '';

            if (data.success) {
                showToast(data.message, 'success');
                validationResult.className = 'validation-result success';
                const h4 = document.createElement('h4');
                h4.textContent = '‚úì Saved Successfully';
                const p = document.createElement('p');
                p.textContent = 'Run ';
                const code = document.createElement('code');
                code.textContent = 'sdbx down && sdbx up';
                p.appendChild(code);
                p.appendChild(document.createTextNode(' to apply changes.'));
                validationResult.appendChild(h4);
                validationResult.appendChild(p);
                validationResult.style.display = 'block';
            } else {
                let errorMsg = data.message;
                if (data.errors && data.errors.length > 0) {
                    errorMsg += ':\n' + data.errors.join('\n');
                }
                showToast(errorMsg, 'error');
                validationResult.className = 'validation-result error';
                const h4 = document.createElement('h4');
                h4.textContent = '‚úó Save Failed';
                const p = document.createElement('p');
                p.textContent = data.message; // Safe: uses textContent
                validationResult.appendChild(h4);
                validationResult.appendChild(p);
                validationResult.style.display = 'block';
            }
            btn.disabled = false;
            btn.textContent = 'üíæ Save';
        })
        .catch(error => {
            showToast('Save failed: ' + error, 'error');
            btn.disabled = false;
            btn.textContent = 'üíæ Save';
        });
    }

    function reloadConfig() {
        if (!confirm('Reload configuration from disk? Any unsaved changes will be lost.')) {
            return;
        }

        fetch('/api/config')
            .then(response => response.text())
            .then(content => {
                editor.value = content;
                updateLineNumbers();
                updateStats();
                validationResult.style.display = 'none';
                showToast('Configuration reloaded', 'success');
            })
            .catch(error => {
                showToast('Failed to reload: ' + error, 'error');
            });
    }
</script>

{{end}}

{{template "base" .}}
